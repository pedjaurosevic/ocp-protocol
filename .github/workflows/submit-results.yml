name: Submit Results to Leaderboard

on:
  workflow_dispatch:
    inputs:
      results_b64:
        description: "Base64-encoded results JSON (output of: base64 -w0 results.json)"
        required: true
      submitter:
        description: "Your GitHub username or display name"
        required: false
        default: "anonymous"

permissions:
  contents: write

jobs:
  submit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Decode and validate results
        id: decode
        run: |
          echo "${{ inputs.results_b64 }}" | base64 -d > /tmp/submitted.json
          python3 - <<'EOF'
          import json, sys, re

          with open("/tmp/submitted.json") as f:
              d = json.load(f)

          required = ["ocp_level", "sasmi_score", "provider", "model"]
          missing = [k for k in required if k not in d]
          if missing:
              print(f"ERROR: Missing required fields: {missing}", file=sys.stderr)
              sys.exit(1)

          provider = re.sub(r"[^a-zA-Z0-9._-]", "_", str(d["provider"]))
          model = re.sub(r"[^a-zA-Z0-9._-]", "_", str(d["model"]))
          ts = int(d.get("timestamp", 0)) or __import__("time").time_ns() // 1_000_000_000
          fname = f"results_{provider}_{model}_{ts}.json"

          print(f"MODEL={provider}/{d['model']}")
          print(f"LEVEL=OCP-{d['ocp_level']} {d.get('ocp_level_name','')}")
          print(f"SASMI={d['sasmi_score']}")
          print(f"FILENAME={fname}")

          with open("/tmp/result_filename.txt", "w") as f:
              f.write(fname)
          EOF
          echo "filename=$(cat /tmp/result_filename.txt)" >> $GITHUB_OUTPUT

      - name: Add results file
        run: |
          FNAME="${{ steps.decode.outputs.filename }}"
          cp /tmp/submitted.json "docs/results/$FNAME"
          echo "Saved as docs/results/$FNAME"

      - name: Regenerate index.json
        run: |
          python3 - <<'EOF'
          import json, glob, os
          files = sorted(
              os.path.basename(f)
              for f in glob.glob("docs/results/results_*.json")
          )
          with open("docs/results/index.json", "w") as fh:
              json.dump({"files": files, "count": len(files)}, fh, indent=2)
          print(f"index.json updated: {len(files)} models")
          EOF

      - name: Commit and push
        run: |
          git config user.name  "ocp-leaderboard[bot]"
          git config user.email "ocp-leaderboard[bot]@users.noreply.github.com"
          git add docs/results/
          git commit -m "results: add ${{ inputs.submitter }} — ${{ steps.decode.outputs.filename }}"
          git push
          echo ""
          echo "✅ Results submitted! View at: https://pedjaurosevic.github.io/ocp-protocol/"
